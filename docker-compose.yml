services:
  vllm:
    image: nvcr.io/nvidia/vllm:26.01-py3
    command: >-
      vllm serve Qwen/Qwen3-32B-FP8
      --host 0.0.0.0
      --port 8000
      --max-model-len 32768
      --gpu-memory-utilization 0.9
      --max-num-seqs 4
      --enable-auto-tool-choice
      --tool-call-parser hermes
    volumes:
      - ~/.cache/huggingface:/root/.cache/huggingface
    ports:
      - "8000:8000"
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    restart: unless-stopped
    networks:
      - pydantic-net

  searxng:
    image: searxng/searxng:latest
    volumes:
      - ~/searxng/config:/etc/searxng
    restart: unless-stopped
    networks:
      - pydantic-net

  pydantic-bot:
    build: .
    env_file: .env
    volumes:
      - ./src:/app
      - ~/projects/pydantic-assets/gog:/app/gog:ro
      - ~/.config/gogcli:/root/.config/gogcli:ro
    depends_on:
      - vllm
      - searxng
    restart: unless-stopped
    networks:
      - pydantic-net

  git-sync:
    build:
      context: .
      dockerfile: Dockerfile.sync
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - .:/repo
    environment:
      - SYNC_INTERVAL=5
      - BOT_CONTAINER=pydantic-pydantic-bot-1
    restart: unless-stopped
    networks:
      - pydantic-net

networks:
  pydantic-net:
    driver: bridge
